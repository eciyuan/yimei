<include file="Public/mobile_head"/>
<link rel="stylesheet" href="__STATIC__/mui.3.5.0/css/mui.min.css?v={:SITE_VERSION}">
<link href="{:ADDON_PUBLIC_PATH}/css.css?v={:SITE_VERSION}" rel="stylesheet" type="text/css">
<body id="body_box" style="position: static;">
<include file="header"/>
<!--下拉刷新容器-->
    <div id="pullrefresh"  class="mui-content mui-scroll-wrapper" >
         <div class="mui-scroll">
                <div class="mui-card" style="margin:0px;">
                     <div class="mui-row">
                        <div class="mui-card-header">
                            <div class=" mui-col-xs-5">
                                <li class="">编号</li>
                            </div>
                            <div class="mui-col-xs-5">
                                <li class="">标题</li>
                            </div>
                            <div class="mui-col-xs-2">
                                <li class="">状态</li>
                            </div>
                        </div>
                    </div>
                     <div class="mui-row">
                     <div class="mui-card-content">
                           <template v-if="is_nodata == '1'">
                                 <ul  class="mui-table-view  mui-table-view-chevron">
                                    <template v-for="item in demoData" >
                                        <li class="mui-table-view-cell mui-collapse">
                                            <a class="mui-navigate-right">
                                                <div class=" mui-col-xs-5" style="float: left;font-size: 6px;">{{item.order_number}}</div>
                                                <div class=" mui-col-xs-5" style="float: left;font-size: 6px;">{{item.title}}</div>
                                                <div class=" mui-col-xs-2" style="float: left;font-size: 6px;">
                                                        <span v-if="item.pay_status == '0'" class="mui-badge mui-badge-danger mui-badge-inverted">待支付</span>
                                                         <!-- 已经支付,进行各种操作-->
                                                        <span v-if="item.pay_status == '1' && item.order_status == '0'" class="mui-badge mui-badge-danger mui-badge-inverted">进行中</span>
                                                        <span v-if="item.pay_status == '1' && item.order_status == '1'" class="mui-badge mui-badge-danger mui-badge-inverted">进行中</span>
                                                        <span v-if="item.pay_status == '1' && item.order_status == '2'" class="mui-badge mui-badge-danger mui-badge-inverted">评价</span>
                                                        <span v-if="item.pay_status == '1' &&  item.order_status == '3'" class="mui-badge mui-badge-success mui-badge-inverted">成功</span>
                                                </div>
                                            </a>
                                            <div class="mui-collapse-content">
                                                <p v-on:click="show_order_detail(item.id)" data-id="{{item.id}}" from="1"  price="{{item.price}}" class="click-change"><a><span class="mui-badge  mui-badge-warning mui-badge-inverted">查看详情</span></a></p>
                                                <p v-on:click="del_order(item.id)" data-id="{{item.id}}" from="2"  price="{{item.price}}" class="click-change"><a><span class="mui-badge  mui-badge-warning mui-badge-inverted">删除</span></a></p>
                                                    <p v-if="item.pay_status == '0'" data-id="{{item.id}}" from="3"  price="{{item.price}}" class="click-change"> <a><span class="mui-badge  mui-badge-warning mui-badge-inverted">提高悬赏</span></a></p>
                                                    <p v-if="item.pay_status == '0'" data-id="{{item.id}}" from="4" price="{{item.price}}" class="click-change"><a id="toPay" data="{{item.id}}"><span class="mui-badge  mui-badge-warning mui-badge-inverted">前去支付</span></a></p>
                                                    <p v-if="item.pay_status == '1' && item.order_status == '2'" data-id="{{item.id}}" from="5" price="{{item.price}}" class="click-change"><a id="" data="{{item.id}}"><span class="mui-badge  mui-badge-warning mui-badge-inverted">前去评价</span></a></p>
                                            </div>
                                        </li>
                                    </template>
                                 </ul>
                             </template>
                            <template v-else>
                                <div class="empty_container"><p>{{message}}</p></div>
                            </template>
                        </div>
                 </div>
                </div>
             </div>
        <!-- 底部导航 -->
        <include file="_footer"/>
      </div>
    <script src="__STATIC__/mui.3.5.0/js/mui.min.js?v={:SITE_VERSION}"></script>
    <script src="__STATIC__/vue.2.2.0/vue.min.2.2.1.js?v={:SITE_VERSION}"></script>
    <script src="{:ADDON_PUBLIC_PATH}/custome.js?v={:SITE_VERSION}"></script>
    <script>
        var url_http="{:addons_url('HumanTranslation://Wap/myOrderAjax')}";
        mui.init({
            pullRefresh : {
                container:"#pullrefresh",//待刷新区域标识，querySelector能定位的css选择器均可，比如：id、.class等
                up : {
                    height:50,//可选.默认50.触发上拉加载拖动距离
                    auto:true,//可选,默认false.自动上拉加载一次
                    contentrefresh : "正在加载...",//可选，正在加载状态时，上拉加载控件上显示的标题内容
                    contentnomore:'没有更多数据了',//可选，请求完毕若没有更多数据时显示的提醒内容；
                    callback :pullupRefresh //必选，刷新函数，根据具体业务来编写，比如通过ajax从服务器获取新数据；
                },
                down: {
                    //下拉刷新
                    auto:true,//可选,默认false.自动下拉刷新一次
                    contentdown : "下拉可以刷新",//可选，在下拉可刷新状态时，下拉刷新控件上显示的标题内容
                    contentover : "释放立即刷新",//可选，在释放可刷新状态时，下拉刷新控件上显示的标题内容
                    contentrefresh : "正在刷新...",//可选，正在刷新状态时，下拉刷新控件上显示的标题内容
                    callback: pulldownRefresh
                },
            }
        });
        if(mui.os.plus) {
            mui.plusReady(function() {
                setTimeout(function() {
                    mui('#pullrefresh').pullRefresh().pulldownLoading();
                }, 1000);
            });
        } else {
            mui.ready(function() {
                mui('#pullrefresh').pullRefresh().pulldownLoading();
            });
        }
        //下拉刷新
        function pulldownRefresh() {
            setTimeout(function() {
                start = 1;//刷新并显示第一页
                data={
                    start:0,
                    limit:10
                };
                type=1;//代表下拉刷新
                toList(data,type);//具体取数据的方法
            }, 100);
        }
        //上拉加载
        function pullupRefresh() {
            setTimeout(function() {
                start+=vmOrder.start;
                limit=10;
                data={
                    start:start,
                    limit:limit
                };
                type=2;//代表上拉加载
                toList(data,type);//具体取数据的方法
            }, 100);
        }
        /*vue 开始*/
        var vmOrder = new Vue({
            el: '#body_box',
            data: {
                companylist: null,
            },
            created: function() {
            }
        });
       // mui('body').on('tap','a',function(){document.location.href=this.href;});
        var toList = function(data,type) {
           // plus.nativeUI.showWaiting("等待中....",{padlock: true});//数据出来前显示等待加载框
            mui.ajax(url_http, {
                data:data,
                dataType: 'json',
                type: 'POST',
                timeout: 10000,
                success: function(data) {
                    if (data.status!=1&&start==1){
                        vmOrder.$set('is_nodata', '0');
                        vmOrder.$set('message', '空空如也！');
                        mui('#pullrefresh').pullRefresh().endPulldownToRefresh();//结束下拉刷新
                        mui('#pullrefresh').pullRefresh().endPullupToRefresh(true);
                    }else{
                        for (var i in data.info) {
                            var arr = new Array();
                            for (var item in data.info[i]) {
                                arr[item] = data.info[i][item];
                            }
                            if(type==1){
                                //上拉刷新
                                /*下面这句很关键！*/
                                mui('#pullrefresh').pullRefresh().refresh(true);//有重新触发上拉加载的需求（比如当前类别已无更多数据，但切换到另外一个类别后，应支持继续上拉加载）
                                vmOrder.companylist = data.info;
                                vmOrder.$set('is_nodata', '1');
                                vmOrder.$set('demoData', vmOrder.companylist);  //把数据传给页面
                                vmOrder.$set('start', vmOrder.companylist.length);
                            }
                            if(type==2){
                                //下拉加载
                                vmOrder.companylist.push(arr);
                                vmOrder.$set('is_nodata', '1');
                                vmOrder.$set('demoData', vmOrder.companylist);  //把数据传给页面
                                vmOrder.$set('start', vmOrder.companylist.length);
                            }
                        }
                        mui('#pullrefresh').pullRefresh().endPulldownToRefresh();//结束下拉刷新
                        /*结束上拉加载，并根据情况切换“下拉显示更多数据”，以及“没有更多数据了”。执行endPullupToRefresh()方法，结束转雪花进度条的“正在加载...”过程,若还有更多数据，则传入false; 否则传入true，之后滚动条滚动到底时*/
                        mui('#pullrefresh').pullRefresh().endPullupToRefresh(false);
                    }
                },
                error: function(xhr, type, errerThrown) {
                    mui.toast('网络异常,请稍候再试');
                    mui('#pullrefresh').pullRefresh().endPullupToRefresh(true);
                }
            });
        };
        function delOrder(id){
            var btnArray = ['否', '是'];
            mui.confirm('你确认删除该订单？', '', btnArray, function(e) {
                if (e.index == 1) {
                    $.Dialog.loading();
                    $.ajax({
                        type: 'post',
                        url:"{:addons_url('HumanTranslation://Wap/del_order')}",
                        data: {id:id},
                        dataType: 'json',
                        success: function (result) {
                            if (result.status==1){
                                $.Dialog.success(result.info);
                                $(".mui-active").remove();
                            }else {
                                $.Dialog.fail(result.info);
                            }
                        }
                    });
                } else {
                    // $.Dialog.fail('网络错误，请重试!');
                }
            })
        }
        /*公共底部菜单js*/
        mui(".bottom_menu").on('tap','.list-page-bottom',function(){
            //获取id
            var from = this.getAttribute("data");
            if(from==1){
                var url = "{:addons_url('HumanTranslation://Wap/index', array('token'=>$token))}";
            }else if(from==2){
                var url = "{:addons_url('HumanTranslation://Wap/translate', array('token'=>$token))}";
            }else{
                var url = "{:addons_url('HumanTranslation://Wap/ucenter', array('token'=>$token))}";
            }
            mui.openWindow({
                url: url,
            })
        })
        mui(".mui-content").on('tap','.click-change',function(){
            //获取id
            var id = this.getAttribute("data-id");
            var from = this.getAttribute("from");
            var price = this.getAttribute("price");
            if(from==1){
                //查看详情
                var url = "{:addons_url('HumanTranslation://Wap/orderDetail')}&id="+id;
                mui.openWindow({
                    url: url,
                    id: id,
                })
            }else if(from==2){
                //删除
                delOrder(id);
            }else if(from==3){
                //提高悬赏
                var url = "{:addons_url('HumanTranslation://Wap/editIndex')}&id="+id;
                var html='<div class="mui-input-row"><input class="mui-numbox-input" name="price"  id="price" type="number" /></div><span id="error">&nbsp</span>';
                mui.confirm(html, '请输入要增加价格', null, function(event) {
                    var index = event.index;
                    console.log(event);
                    if(index === 1) {
                        price = $('#price').val();
                        if (price == null || price == '' || price == undefined) {
                            $("#error").html('价格不能为空');
                            return false;
                        }
                        mui.post(url, {
                            price: price,
                            id: id
                            }, function (data) {
                                if(data.status==1){
                                    $.Dialog.success(data.info);
                                }else{
                                    $.Dialog.fail(data.info);
                                }
                                if(data.url!=""&&data.url!=undefined){
                                    setTimeout(function(){
                                        window.location.href=data.url;
                                    },2000);
                                }
                            }, 'json'
                        );
                    }
                });
                return false;
            }else if(from==5){
                //评价页面显示
                var url = "{:addons_url('HumanTranslation://Wap/comment')}&id="+id;
                var html='<div class="mui-input-row"><textarea class="textarea" name="desc"  id="desc" rows="4" ></textarea></div><span id="error">&nbsp</span>';
                mui.confirm(html, '请输入要评价内容', null, function(event) {
                    var index = event.index;
                    console.log(event);
                    if(index === 1) {
                        desc = $('#desc').val();
                        if (desc == null || desc == '' || desc == undefined) {
                            $("#error").html('价格不能为空');
                            return false;
                        }
                        mui.post(url, {
                            desc: desc,
                            id: id
                                }, function (data) {
                                    if(data.status==1){
                                        $.Dialog.success(data.info);
                                    }else{
                                        $.Dialog.fail(data.info);
                                    }
                                }, 'json'
                        );
                    }
                });
                return false;
            }else{
                //前去支付 from=4
                var url = "{:addons_url('HumanTranslation://Wap/choose_pay')}&id="+id+"&price="+price+"&invite_uid="+{$uid};
                mui.openWindow({
                    url: url,
                    id: id,
                })
            }
        })
    </script>
</body>
</html>